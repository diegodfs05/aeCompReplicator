(function(thisObj){if(typeof String.prototype.trim!=="function"){String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}}if(typeof JSON==="undefined"){JSON={parse:function(r){return eval("("+r+")")},stringify:function(){throw new Error("JSON.stringify not implemented.")}}}if(typeof Array.isArray==="undefined"){Array.isArray=function(r){return Object.prototype.toString.call(r)==="[object Array]"}}var mainPanel,compDropdown,reloadBtn,formatDropdown,jsonLabel,browseBtn,fieldsCountInput,setFieldsBtn,fieldsGroup,layerSelectors=[],processBtn;function buildUI(e){var t=e instanceof Panel?e:new Window("palette","Replicador de Comp",void 0,{resizeable:!0});return mainPanel=t,t.orientation="column",t.alignChildren=["fill","top"],t.add("statictext",void 0,"Selecione a Composição:"),function(){var r=t.add("group");r.orientation="row",r.alignChildren=["fill","center"],r.alignment=["fill","top"],compDropdown=r.add("dropdownlist",void 0,[]),compDropdown.alignment=["fill","center"],reloadBtn=r.add("button",void 0,"Recarregar Compos")}(),t.add("statictext",void 0,"Selecione o Formato de Arquivo de Dados:"),function(){var r=t.add("group");r.orientation="row",r.alignChildren=["fill","center"],r.alignment=["fill","top"],formatDropdown=r.add("dropdownlist",void 0,["JSON","CSV"]),formatDropdown.selection=0,formatDropdown.alignment=["fill","center"]}(),t.add("statictext",void 0,"Selecione o Arquivo:"),function(){var r=t.add("group");r.orientation="row",r.alignChildren=["fill","center"],r.alignment=["fill","top"],jsonLabel=r.add("statictext",void 0,"Nenhum arquivo selecionado"),jsonLabel.alignment=["fill","center"],jsonLabel.preferredSize.width=200,browseBtn=r.add("button",void 0,"Procurar Arquivo..."),browseBtn.alignment=["right","center"]}(),t.add("statictext",void 0,"Número de camadas de texto a processar:"),function(){var r=t.add("group");r.orientation="row",r.alignChildren=["fill","center"],r.alignment=["fill","top"],fieldsCountInput=r.add("edittext",void 0,"0"),fieldsCountInput.characters=4,fieldsCountInput.alignment=["left","center"],setFieldsBtn=r.add("button",void 0,"Definir Campos"),setFieldsBtn.alignment=["right","center"]}(),fieldsGroup=t.add("group"),fieldsGroup.orientation="column",fieldsGroup.alignChildren=["fill","top"],fieldsGroup.alignment=["fill","top"],processBtn=t.add("button",void 0,"Replicar Comps"),processBtn.alignment=["fill","top"],reloadBtn.onClick=function(){populateCompList()},browseBtn.onClick=function(){var r=formatDropdown.selection?formatDropdown.selection.text:"JSON",o=r==="CSV"?"*.csv":"*.json",a=File.openDialog("Selecione arquivo "+r,o);a&&a.exists&&(jsonLabel.text=decodeURI(a.fsName))},setFieldsBtn.onClick=function(){clearLayerSelectors();var r=parseInt(fieldsCountInput.text,10);if(isNaN(r)||r<1)return alert("Por favor, insira um número válido e positivo de camadas de texto."),void 0;createFieldSelectors(r)},processBtn.onClick=replicateComps,populateCompList(),t instanceof Window&&(t.center(),t.show()),t}function populateCompList(){if(!compDropdown)return;compDropdown.removeAll();var e=app.project;if(e&&e.numItems>0)for(var t=1;t<=e.numItems;t++){var r=e.item(t);r instanceof CompItem&&compDropdown.add("item",r.name)}compDropdown.items.length>0&&(compDropdown.selection=0)}function createFieldSelectors(e){var t=compDropdown.selection?compDropdown.selection.text:null;if(!t)return void alert("Nenhuma composição selecionada.");var r=findCompByName(t);if(!r)return void alert("Composição selecionada não foi encontrada.");for(var o=[],a=1;a<=r.numLayers;a++){var n=r.layer(a);n.matchName==="ADBE Text Layer"&&o.push(n.name)}for(var i=0;i<e;i++){var l=fieldsGroup.add("group");l.orientation="row",l.alignChildren=["fill","center"],l.alignment=["fill","top"];var s=l.add("dropdownlist",void 0,o);s.alignment=["fill","center"],o.length>0&&(s.selection=0),layerSelectors.push(s)}fieldsGroup.layout.layout(!0),mainPanel.layout.layout(!0)}function clearLayerSelectors(){for(;fieldsGroup.children.length>0;)fieldsGroup.remove(fieldsGroup.children[0]);layerSelectors=[],fieldsGroup.layout.layout(!0),mainPanel.layout.layout(!0)}function replicateComps(){app.beginUndoGroup("Replicar Comps");try{var e=app.project;if(!e)return void alert("Nenhum projeto aberto.");if(!compDropdown.selection)return void alert("Selecione uma composição primeiro.");var t=compDropdown.selection.text,r=findCompByName(t);if(!r)return void alert("A composição selecionada não foi encontrada no projeto.");var o=formatDropdown.selection?formatDropdown.selection.text:"JSON",a=jsonLabel.text;if(!a||a==="Nenhum arquivo selecionado")return void alert("Por favor, selecione um arquivo de dados ("+o+").");var n=new File(a);if(!n.exists)return void alert("O arquivo de dados selecionado não existe.");n.open("r");var i=n.read();n.close();var l=parseDataFile(o,i);if(!l||!Array.isArray(l)||l.length===0)return void alert("Não foram encontradas linhas válidas no arquivo "+o+".");if(layerSelectors.length===0)return void alert('Nenhum campo de texto foi configurado. Clique em "Definir Campos" depois de especificar um número.');for(var s=0;s<l.length;s++){var c=l[s],f=r.duplicate();f.name=r.name+"_"+(s+1);for(var p=0;p<layerSelectors.length;p++){if(p>=c.length)break;var d=layerSelectors[p].selection?layerSelectors[p].selection.text:null;if(!d)continue;var m=findLayerByName(f,d);if(!m)continue;var u=m.property("Source Text");if(u){var h=u.value;h.text=String(c[p]),u.setValue(h)}}}alert("Foram replicadas "+l.length+" composições com sucesso!")}catch(g){alert("Erro: "+g.toString())}finally{app.endUndoGroup()}}function parseDataFile(e,t){var r=[];if(e==="CSV"){for(var o=t.split("\n"),a=0;a<o.length;a++){var n=o[a].replace(/\r$/,"").trim();if(n==="")continue;var i=n.split(";");for(var l=0;l<i.length;l++){var s=i[l].trim().replace(/^"(.*)"$/,"$1");i[l]=s}r.push(i)}}else{var c=JSON.parse(t);if(!Array.isArray(c))return alert("O JSON deve ser um array (de objetos ou arrays)."),null;if(Array.isArray(c[0]))r=c;else for(var f=0;f<c.length;f++){var p=c[f],d=[];for(var m in p)p.hasOwnProperty(m)&&d.push(p[m]);r.push(d)}}return r}function findCompByName(e){var t=app.project;if(!t)return null;for(var r=1;r<=t.numItems;r++){var o=t.item(r);if(o instanceof CompItem&&o.name===e)return o}return null}function findLayerByName(e,t){for(var r=1;r<=e.numLayers;r++){var o=e.layer(r);if(o.name===t)return o}return null}var myScriptPal=buildUI(thisObj);myScriptPal instanceof Window===!1&&myScriptPal.layout.layout(!0)})(this);
